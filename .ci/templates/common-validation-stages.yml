parameters:
- name: moduleFolderName
  type: string
- name: moduleDisplayName
  type: string

stages:
- stage: 'Validation_${{ parameters.moduleDisplayName }}' # Valid stage name cannot contain the character '.'
  displayName: 'Validate Package ${{ parameters.moduleFolderName }}'
  pool:
    vmImage: ubuntu-20.04
  jobs:
  - job: Validate
    displayName: 'Validate ${{ parameters.moduleFolderName }}'
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: Scripting Metadata
        scriptLocation: 'inlineScript'
        scriptType: 'pscore'
        inlineScript: |
          $accessToken = az account get-access-token --query accessToken --resource 499b84ac-1321-427f-aa17-267ca6975798 -o tsv
          Write-Host "##vso[task.setsecret]$accessToken"
          $env:AZURE_DEVOPS_EXT_PAT=$accessToken
          az artifacts universal download `
            --organization $(feedAuthority) `
            --project=$(feedProject) `
            --scope project `
            --feed $(metadataFeed) `
            --name shuttle `
            --version $(shuttleVersion) `
            --path shuttle          
        displayName: Prepare shuttle
    - task: PowerShell@2
      displayName: 'Restore Dependencies for ${{ parameters.moduleFolderName }}'
      inputs:
        filePath: '.build-tools/getRequiredModules.ps1'
        arguments: '${{ parameters.moduleFolderName }}/${{ parameters.moduleFolderName }}.psd1'
        pwsh: true
    - task: PowerShell@2
      displayName: 'Pre-Validate Module and Scripts for ${{ parameters.moduleFolderName }}' #PSGallery publishing guidelines: https://docs.microsoft.com/en-us/powershell/scripting/gallery/how-to/publishing-packages/publishing-a-package?view=powershell-7.1#pre-validate-your-item
      inputs:
        filePath: 'tests/prevalidateModules.ps1'
        arguments: '${{ parameters.moduleFolderName }}'
        pwsh: true
    - powershell: |
        .build-tools/publish.ps1 `
          '$(System.DefaultWorkingDirectory)/${{ parameters.moduleFolderName }}/${{ parameters.moduleFolderName }}.psd1' `
          $(Build.BuildNumber) `
          '' `
          @{ Name = "Temp"; SourceLocation = "/tmp"; PublishLocation = "/tmp"; InstallationPolicy = 'Trusted' }
      displayName: 'Test publish'
    - powershell: |
        echo "+ ${{ parameters.moduleFolderName }}@$(moduleVersion)" > shuttle/baseline
        dotnet shuttle/Shuttle.dll generate
      env:
        METADATA: uri://console
      displayName: 'Generate metadata'
